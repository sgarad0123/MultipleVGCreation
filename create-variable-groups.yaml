trigger: none

parameters:
  - name: environments
    type: object
    default: ['DEV', 'SIT', 'UAT', 'PT', 'PROD', 'DR']

pool:
  name: AKS
  vmImage: 'ubuntu-latest'

variables:
  - group: vg-create-vg-source
  - group: devops-secrets-vg 

steps:
  - script: |
      chmod +x ./create-multi-env-vgs.sh

      echo "üîÅ Environments to process:"
      environments="${{ join(',', parameters.environments) }}"
      IFS=',' read -ra ENV_LIST <<< "$environments"

      # Export Azure DevOps variables as shell environment variables
      echo "üì§ Exporting variable group contents to shell environment"
      set -o allexport
      source <(env | grep '^track[0-9]*_' || true)
      set +o allexport

      echo "Found TRACKCOUNT=$TRACKCOUNT from variable group"

      for ((i=1; i<=${TRACKCOUNT}; i++)); do
        trackname=$(eval echo "\$track${i}_name")
        tracktype=$(eval echo "\$track${i}_type")
        appid=$(eval echo "\$track${i}_appid")

        echo "üß© Track $i: name=$trackname, type=$tracktype, appid=$appid"

        for env in "${ENV_LIST[@]}"; do
          echo "‚û°Ô∏è Creating variable group for $env - $appid - $trackname"
          ./create-multi-env-vgs.sh "$env" "$appid" "$trackname" "$tracktype"
        done
      done
    displayName: 'Create Env-specific Variable Groups from vg-create-vg-source'
