trigger: none

pool:
  name: AKS
  vmImage: 'ubuntu-latest'

variables:
  - group: vg-create-vg-source
  - group: devops-secrets-vg

parameters:
  - name: environments
    type: object
    default: ['DEV', 'SIT', 'UAT', 'PT', 'PROD', 'DR']

steps:
  # Task 1: Install jq and set permissions
  - task: Bash@3 # Indent 2 spaces from 'steps:'
    displayName: "‚öôÔ∏è Install jq and set permissions" # Indent 4 spaces from '- task:'
    inputs: # Indent 4 spaces from '- task:'
      targetType: 'inline' # Indent 6 spaces from 'inputs:'
      script: | # Indent 6 spaces from 'inputs:'
        # All lines of the script must be indented 2 spaces further than 'script: |'
        echo "Installing jq for JSON processing..."
        sudo apt-get update && sudo apt-get install -y jq
        echo "jq installed."
        
        echo "Making create-multi-env-vgs.sh executable..."
        chmod +x ./create-multi-env-vgs.sh
        echo "Permissions set."

  # Task 2: Create Variable Groups
  - task: Bash@3 # Indent 2 spaces from 'steps:'
    displayName: "üöÄ Create Variable Groups" # Indent 4 spaces from '- task:'
    inputs: # Indent 4 spaces from '- task:'
      targetType: 'inline' # Indent 6 spaces from 'inputs:'
      # THIS IS THE CRITICAL SECTION FOR YOUR ERROR.
      # Ensure 'env:' is at the *exact same* indentation level as 'targetType:' and 'script:'
      env: # <--- Make sure 'env:' is indented 6 spaces from 'inputs:'
        ORG: $(ORG) # Indent 8 spaces from 'env:'
        PROJECT: $(PROJECT) # Indent 8 spaces from 'env:'
        AZURE_DEVOPS_PAT: $(AZURE_DEVOPS_PAT) # Indent 8 spaces from 'env:'
        TRACK1_NAME: $(track1_name) # Indent 8 spaces from 'env:'
        TRACK1_TYPE: $(track1_type) # Indent 8 spaces from 'env:'
        TRACK1_APPID: $(track1_appid) # Indent 8 spaces from 'env:'
        TRACK1_APPTYPE: $(track1_apptype) # Indent 8 spaces from 'env:'
      script: | # Indent 6 spaces from 'inputs:'
        # All lines of the script must be indented 2 spaces further than 'script: |'
        echo "Starting Variable Group Creation process..."

        ORG="${ORG}"
        PROJECT="${PROJECT}"
        AZURE_DEVOPS_PAT="${AZURE_DEVOPS_PAT}"

        trackname="${TRACK1_NAME}"
        tracktype="${TRACK1_TYPE}"
        appid="${TRACK1_APPID}"
        apptype="${TRACK1_APPTYPE}"

        if [[ -z "$trackname" || -z "$tracktype" || -z "$appid" || -z "$apptype" ]]; then
          echo "‚ùå ERROR: Missing track1 input from variable group."
          echo "Please ensure 'track1_name', 'track1_type', 'track1_appid', 'track1_apptype' are set in 'vg-create-vg-source'."
          exit 1
        fi

        echo "üß© Track 1 details: name=$trackname, type=$tracktype, appid=$appid, apptype=$apptype"
        echo "Azure DevOps Org: $ORG, Project: $PROJECT"

        environments_str="${{ join(' ', parameters.environments) }}"
        IFS=' ' read -r -a environments_array <<< "$environments_str"

        echo "üîÅ Environments to process: ${environments_array[@]}"

        for env in "${environments_array[@]}"; do
          echo "‚û°Ô∏è Attempting to create variable group for environment: $env"
          ./create-multi-env-vgs.sh "$env" "$appid" "$trackname" "$tracktype" "$apptype" "$ORG" "$PROJECT" "$AZURE_DEVOPS_PAT"
        done

        echo "Variable Group Creation process completed."
