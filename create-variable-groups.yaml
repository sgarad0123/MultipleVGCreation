trigger: none

parameters:
  - name: environments
    type: object
    default: ['DEV', 'SIT', 'UAT', 'PT', 'PROD', 'DR']

pool:
  name: AKS
  vmImage: 'ubuntu-latest'

variables:
  - group: vg-create-vg-source
  - group: devops-secrets-vg

steps:
  - script: |
      echo "ðŸ”§ Generating export-vars.sh..."

      echo '#!/bin/bash' > export-vars.sh
      echo "export ORG=\"$(ORG)\"" >> export-vars.sh
      echo "export PROJECT=\"$(PROJECT)\"" >> export-vars.sh
      echo "export AZURE_DEVOPS_PAT=\"$(AZURE_DEVOPS_PAT)\"" >> export-vars.sh
      echo "export TRACKCOUNT=$(TRACKCOUNT)" >> export-vars.sh

      echo "" >> export-vars.sh
      echo "# Dynamically export all trackN_* variables" >> export-vars.sh

      TRACKCOUNT=$(TRACKCOUNT)
      for i in $(seq 1 $TRACKCOUNT); do
        name_var="track${i}_name"
        type_var="track${i}_type"
        appid_var="track${i}_appid"
        apptype_var="track${i}_apptype"

        echo "export ${name_var}=\"${!name_var}\"" >> export-vars.sh
        echo "export ${type_var}=\"${!type_var}\"" >> export-vars.sh
        echo "export ${appid_var}=\"${!appid_var}\"" >> export-vars.sh
        echo "export ${apptype_var}=\"${!apptype_var}\"" >> export-vars.sh
      done

      chmod +x export-vars.sh
      echo "âœ… export-vars.sh created with:"
      cat export-vars.sh
    displayName: 'ðŸ”§ Dynamically Generate export-vars.sh'

  - script: |
      chmod +x export-vars.sh
      source ./export-vars.sh

      chmod +x ./process-vg-create-vg-source.sh
      ./process-vg-create-vg-source.sh "${{ join(',', parameters.environments) }}"
    displayName: 'ðŸš€ Create Env-Specific Variable Groups'
